.deploy_wallet: &deploy_wallet
    - echo "Deploying image with tag $DOCKER_IMAGE_TAG -- https://hub.docker.com/r/jimber/wallet"
    - docker pull jimber/wallet:$DOCKER_IMAGE_TAG
    - docker rm -f wallet || true
    - docker run -d -it --network=jimber_proxy_net --name wallet jimber/wallet:$DOCKER_IMAGE_TAG
    - curl -s -X POST "https://api.telegram.org/bot868129294:AAGLGOySYvJJxvIcMHY3XHFaPEPq2MpdGys/sendMessage" -d parse_mode=markdown -d chat_id=-1001186043363 -d parse_mode=markdown -d text="Deployed $ENVIROMENT_NAME wallet version:$CI_COMMIT_REF_NAME commit:$CI_COMMIT_SHORT_SHA"

.deploy_wallet_beta: &deploy_wallet_beta
    - echo "Deploying image with tag $DOCKER_IMAGE_TAG -- https://hub.docker.com/r/jimber/wallet"
    - docker pull jimber/wallet:$DOCKER_IMAGE_TAG
    - docker rm -f wallet_beta || true
    - docker run -d -it --network=jimber_proxy_net --name wallet_beta -p 8888:80 jimber/wallet:$DOCKER_IMAGE_TAG
    - curl -s -X POST "https://api.telegram.org/bot868129294:AAGLGOySYvJJxvIcMHY3XHFaPEPq2MpdGys/sendMessage" -d parse_mode=markdown -d chat_id=-1001186043363 -d parse_mode=markdown -d text="(Beta)Deployed $ENVIROMENT_NAME wallet version:$CI_COMMIT_REF_NAME commit:$CI_COMMIT_SHORT_SHA"

.set_ci_version: &set_ci_version
    - eval "[ -z "$CI_COMMIT_TAG" ] && export VERSION=$CI_COMMIT_SHORT_SHA || export VERSION=$CI_COMMIT_TAG "
    - sed -i "s/{{version}}/$VERSION/g" public/version.js

.build_wallet: &build_wallet
    - cp public/$ENVIROMENT_NAME.config.js public/config.js
    - docker build -t jimber/wallet:$DOCKER_IMAGE_TAG .
    - echo "$DOCKER_PW" | docker login -u $DOCKER_USER --password-stdin
    - docker push jimber/wallet:$DOCKER_IMAGE_TAG

cache:
    paths:
        - node_modules/
        - .yarn

stages:
    - test
    - build
    - deploy

test:
    stage: test
    tags:
        - builder
    script:
        - docker build -t wallet-test -f test.dockerfile .
        - docker run --rm wallet-test

build:testing:
    stage: build
    only:
        - /^v(\d+\.)?(\d+\.)?(\*|\d+)-test\d*$/
    dependencies:
        - test
    variables:
        ENVIROMENT_NAME: testing
        DOCKER_IMAGE_TAG: testing
    tags:
        - builder
    script:
        - *set_ci_version
        - *build_wallet

deploy:testing:
    stage: deploy
    only:
        - /^v(\d+\.)?(\d+\.)?(\*|\d+)-test\d*$/
    variables:
        GIT_STRATEGY: none
        GIT_CHECKOUT: 'false'
        ENVIROMENT_NAME: testing
        DOCKER_IMAGE_TAG: testing
    tags:
        - testing
    script:
        - *deploy_wallet
    dependencies:
        - build:testing

build:staging:
    stage: build
    only:
        - /^v(\d+\.)?(\d+\.)?(\*|\d+)-rc\d*$/
    dependencies:
        - test
    variables:
        ENVIROMENT_NAME: staging
        DOCKER_IMAGE_TAG: staging
    tags:
        - builder
    script:
        - *set_ci_version
        - *build_wallet

deploy:staging:
    stage: deploy
    when: manual
    only:
        - /^v(\d+\.)?(\d+\.)?(\*|\d+)-rc\d*$/
    variables:
        GIT_STRATEGY: none
        GIT_CHECKOUT: 'false'
        ENVIROMENT_NAME: staging
        DOCKER_IMAGE_TAG: staging

    tags:
        - staging
    script:
        - *deploy_wallet
    dependencies:
        - build:staging

build:production:
    stage: build
    only:
        - /^v(\d+\.)?(\d+\.)?(\*|\d+)$/
    dependencies:
        - test
    tags:
        - builder
    variables:
        ENVIROMENT_NAME: production
        DOCKER_IMAGE_TAG: '${CI_COMMIT_TAG}'
    script:
        - *set_ci_version
        - *build_wallet

deploy:production:
    stage: deploy
    when: manual
    only:
        - /^v(\d+\.)?(\d+\.)?(\*|\d+)$/
    variables:
        ENVIROMENT_NAME: production
        DOCKER_IMAGE_TAG: '${CI_COMMIT_TAG}'
    tags:
        - production
    script:
        - *deploy_wallet
    dependencies:
       - build:production

build:production_beta:
    stage: build
    only:
        - /^b(\d+\.)?(\d+\.)?(\*|\d+)$/
    dependencies:
        - test
    tags:
        - builder
    variables:
        ENVIROMENT_NAME: production_beta
        DOCKER_IMAGE_TAG: '${CI_COMMIT_TAG}'
    script:
        - *set_ci_version
        - *build_wallet

deploy:production_beta:
    stage: deploy
    when: manual
    only:
        - /^b(\d+\.)?(\d+\.)?(\*|\d+)$/
    variables:
        ENVIROMENT_NAME: production_beta
        DOCKER_IMAGE_TAG: '${CI_COMMIT_TAG}'
    tags:
        - production_beta
    script:
        - *deploy_wallet_beta
    dependencies:
       - build:production_beta